<!DOCTYPE html>
<html>
  <head>
    <link rel="icon" type="image/png" href="./favicon.svg" />
    <title>50Fin Loan Eligibility Calculator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css"
    />

    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css"
      rel="stylesheet"
    />
    <link href="./style.css" rel="stylesheet" />
  </head>
  <body>
    <div class="loan-calculator">
      <h1 class="card-title">Check Loan Eligibility</h1>
      <p style="text-align: center">
        Determine the maximum loan amount you are eligible for by selecting from
        a list of approved mutual funds and specifying the quantity for each of
        them.
      </p>
      <img src="loan.svg" class="loan-image" alt="loan" />
      <div class="table-container">
        <table class="table">
          <thead id="thead">
            <tr>
              <th>Fund Name (ISIN)</th>
              <th>Quantity</th>
              <th style="visibility: hidden">Action</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr>
              <td>
                <select class="scrip-select form-control" style="width: 100%">
                  <option></option>
                </select>
              </td>
              <td>
                <input
                  type="number"
                  class="form-control"
                  min="0"
                  step="0.01"
                  style="appearance: none; text-align: right"
                />
              </td>
              <td class="text-right action-cell"></td>
            </tr>
          </tbody>
        </table>

        <div class="add-icon-container">
          <img src="add.svg" class="add-icon" alt="Add icon" />
        </div>

        <div class="loader" style="display: none">
          <img src="loader.gif" alt="Loading..." />
        </div>

        <div class="max-loan-card" style="display: none">
          <span>Maximum Loan Amount</span>
          <span id="maxLoan"></span>
        </div>

        <p id="errorMessage" style="color: #fe2434"></p>
        <div class="d-flex justify-content-center">
          <button id="submitBtn" class="submit-btn">Submit</button>
          <button class="download-btn d-none">View Report</button>
        </div>
        <p class="text-center mt-5 mb-2">Powered By</p>
        <img src="./logo.svg" height="50" width="auto" />
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0"></script>

    <script type="application/javascript">
      let maxLoan = $("#maxLoan");
      let tableBody = $("#tableBody");
      let formControl = $(".form-control");
      let scripSelect = $(".scrip-select");
      let select_options = $(".select2-results__options");
      let errorMessage = $("#errorMessage");
      let addIconContainer = $(".add-icon-container");
      let loader = $($(".loader"));
      let downloadBtn = $(".download-btn");
      let maxLoanCard = $(".max-loan-card");
      let scripJson = [];
      let apiResponse = {};

      $(document).ready(function () {
        $.getJSON("scrip.json", function (data) {
          let scripData = data;
          $.each(scripData, function (key, scrip) {
            let item = {
              name: scrip.name + " (" + scrip.isin + ")",
              isin: scrip.isin,
            };
            scripJson.push(item);
          });
          initializeSelect2(scripSelect);
        });
      });

      //   Initialize select2
      function initializeSelect2(selectElement) {
        $.each(scripJson, function (key, scrip) {
          selectElement.append(new Option(scrip.name, scrip.isin));
        });

        selectElement
          .select2({
            placeholder: "Search fund name or ISIN",
            dropdownAutoWidth: false,
            width: "100%",
          })
          .on("select2:opening", function () {
            select_options.addClass("max-width-option");
            setTimeout(function () {
              $(".select2-search__field")[0].focus();
            }, 10);
          })
          .on("select2:close", function () {
            select_options.removeClass("max-width-option");
          });
      }

      // Add more rows
      $(document).on("click", ".add-icon", function () {
        let newRow = $(
          '<tr><td><select class="scrip-select form-control" style="width: 100%"><option></option></select></td><td><input type="number" class="form-control" min="0" step="0.01" style="appearance: none; text-align: right" /></td><td class="text-right action-cell"><img src="remove.svg" class="remove-icon" alt="Remove icon"/></td></tr>'
        );
        tableBody.append(newRow);
        initializeSelect2(newRow.find("select"));
      });

      // Remove a row
      $(document).on("click", ".remove-icon", function () {
        $(this).closest("tr").remove();
      });

      // Submit Button
      $(document).on("click", "#submitBtn", function () {
        let output = {};
        let error = false;
        let errorMsg = "";
        loader.css("display", "block");
        $(".add-icon").css("display", "none");
        $(".remove-icon").css("display", "none");
        output.isin_quantity = {};
        errorMessage.text("");

        tableBody.find("tr").each(function () {
          let $row = $(this);
          let isin = $row.find("select").val();
          let quantityStr = $row.find("input").val();
          let quantity = parseFloat(quantityStr);
          let apiResponse = {};

          if (!isin && !quantityStr) {
            errorMsg = "Mutual fund not selected and quantity not entered";
            error = true;
          } else if (!isin) {
            errorMsg = "Please select all the mutual funds";
            error = true;
          } else if (!quantityStr) {
            errorMsg = "Enter a valid quantity for all mutual funds";
            error = true;
          } else if (isNaN(quantity) || quantity <= 0) {
            errorMsg = "Enter a valid quantity for all mutual funds";
            error = true;
          } else {
            if (output.isin_quantity[isin]) {
              output.isin_quantity[isin] += quantity;
            } else {
              output.isin_quantity[isin] = quantity;
            }
          }
        });

        if (error) {
          errorMessage.text(errorMsg);
          $(".add-icon").css("display", "block");
          $(".remove-icon").css("display", "block");
          loader.css("display", "none");
        } else {
          $.ajax({
            url: "https://fifty-fin-external-n77ca4jn5a-el.a.run.app/api/v1/generate_configuration/",
            type: "POST",
            data: JSON.stringify(output),
            contentType: "application/json",
            dataType: "json",
            success: function (response) {
              apiResponse = response.data;
              let totalPortfolioAmount = 0;
              let totalMaxLoanAmount = 0;
              $.each(response.data.Approved_ISIN, function (isin, details) {
                let amount = details.quantity * details.price;
                totalPortfolioAmount += details.amount;
                totalMaxLoanAmount += details.max_loan_amount;
              });

              if (totalMaxLoanAmount < 25000) {
                errorMessage.text(
                  "Please add more mutual funds. Minimum portfolio value must be at least â‚¹50,000"
                );
                $(".add-icon").css("display", "block");
                $(".remove-icon").css("display", "block");
                loader.css("display", "none");
                return;
              }

              maxLoanCard.css("display", "flex");
              scripSelect.attr("disabled", "true");
              formControl.attr("disabled", "true");
              maxLoan.text(formatCurrency(totalMaxLoanAmount));
              $("#tableBody tr").each(function () {
                $(this).find("td:last-child").remove();
              });
              $(".add-icon-container").remove();
              $(".remove-icon").remove();
              $("#submitBtn").addClass("d-none");
              downloadBtn.removeClass("d-none");

              confetti({
                particleCount: 100,
                spread: 100,
                origin: { y: 0.6 },
              });

              loader.css("display", "none");
            },
            error: function (jqXHR, textStatus, errorThrown) {
              loader.css("display", "none");
              errorMessage.text(
                "Request failed: " + textStatus + ", " + errorThrown
              );
            },
          });
        }
      });

      function formatCurrency(amount) {
        return new Intl.NumberFormat("en-IN", {
          style: "currency",
          currency: "INR",
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        }).format(amount);
      }

      $(document).on("click", ".download-btn", function () {
        let data = [];
        let totalMaxLoanAmount = 0;
        let totalPortfolioAmount = 0;

        for (let key in apiResponse.Approved_ISIN) {
          let item = apiResponse.Approved_ISIN[key];
          item.price = item.price.toFixed(2);
          item.quantity = item.quantity.toFixed(2);
          item.loan_to_value_ratio = item.loan_to_value_ratio.toFixed(2);
          item.max_loan_amount = item.max_loan_amount.toFixed(2);
          data.push(item);
          totalPortfolioAmount += parseFloat(item.quantity * item.price);
          totalMaxLoanAmount += parseFloat(item.max_loan_amount);
        }

        totalPortfolioAmount = totalPortfolioAmount.toFixed(2);
        totalMaxLoanAmount = totalMaxLoanAmount.toFixed(2);

        localStorage.setItem("totalPortfolioAmount", totalPortfolioAmount);
        localStorage.setItem("totalMaxLoanAmount", totalMaxLoanAmount);
        localStorage.setItem("data", JSON.stringify(data));
        downloadBtn.addClass("d-none");

        window.open("./report/report.html", "_blank");
      });
    </script>
  </body>
</html>
